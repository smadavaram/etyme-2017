App.messages = App.cable.subscriptions.create('MessagesChannel', {
  connected: function() {},
  disconnected: function() {},

  received: function(data) {
    set_conversation(data);
    return ""
  },

  notify: function(message) {
    return alert(message);
  },

  speak: function(massage) {
    return this.perform('speak', {
      massage: massage
    });
  }
});

function set_conversation(data){

  $("#con-text-" + data.con_id+ "-" + data.usr_typ + "-" + data.usr).val('');
  $("#con-atta-" + data.con_id+ "-" + data.usr_typ + "-" + data.usr).val('');
  $("#con-filename-" + data.con_id+ "-" + data.usr_typ + "-" + data.usr).val('');
  $("#con-filesize-" + data.con_id+ "-" + data.usr_typ + "-" + data.usr).val('');
  $("#con-filetype-" + data.con_id+ "-" + data.usr_typ + "-" + data.usr).val('');


  current_user_id = $('meta[name=user-id]').attr("content");
  current_user_type = $('meta[name=user-type]').attr("content");

  if (current_user_id == data.recpt_id && current_user_type == data.recpt_type ){
    if ($("#conversation-chat-box").data("conversation-id") == data.con_id ){
      mark_as_read(data.con_id, data.msg_id, current_user_id, current_user_type, data.chat_typ, data.group_id)
    }else{
      $("#unread-msg-"+current_user_id).html(data.unread_msg_cnt)
    }
  }

  message = (data.msg_att) ? data.msg +" <br/><a href='" + data.msg_att + "' target='_blank'>" + data.msg_att_name +"</a> "  : data.msg
  $(data.dom).append(
    "<div class='" + ((current_user_id == data.usr && current_user_type == data.usr_typ ) ? 'send_message' : 'receive_message') + "'>" +
      "<span>" + message + "</span>" +
    "</div>"
  );

  if($("#conversation_"+data.con_id)[0]){
    $("#conversation_"+data.con_id).scrollTop($("#conversation_"+data.con_id)[0].scrollHeight);
  }
}

function mark_as_read(conversation_id, message_id, cnt_user_id, cnt_user_type, chat_type, group_id){
  $.ajax({
    url: "/conversations/" + conversation_id + "/conversation_messages/" + message_id + "/mark_as_read",
    type: "GET",
    data: { cnt_user_id: cnt_user_id, cnt_user_type: cnt_user_type, chat_type: chat_type, group_id: group_id },
    dataType: "json"
  });
}