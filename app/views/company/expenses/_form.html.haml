#content
  .row
  %section
    .row
      = form_for @expense , html:{class: 'form-horizontal'}  do |f|
        %article.col-sm-12.col-md-12.col-lg-12
          #wid-id-0.jarviswidget{"data-widget-deletebutton" => "false", "data-widget-editbutton" => "false"}
            %header
              %span.widget-icon
                %i.fa.fa-check
              %h2 Adding New Expense
            %div
              .jarviswidget-editbox
              .widget-body
                .row
                  .col-md-3
                    %label Contract
                  .col-md-4
                    = f.select :contract_id, options_for_select(Contract.all.map{|c| [c.title,c.id] }),{required: true, prompt: 'Select Contract' }

                %br
                .row
                  .col-md-3
                    %label Select Account
                  .col-md-4
                    = f.select :account_id, options_for_select(Candidate.all.map{|c| [c.full_name,c.id] }),{required: true, prompt: 'Choose Consultant/Vendor' }

                %br
                .row
                  .col-md-3.form-group
                    %label{:for => "mailing_address"} Mailing Address:
                    = f.text_area :mailing_address, class: 'form-control'

                  .col-md-2
                    %label{:for => "terms"} Terms:
                    = f.select :terms, options_for_select((0..10).to_a.map{ |e| 'Net '+e.to_s}), {required: true }

                  .col-md-2
                    %label{:for => 'bill_date'} Bill Date:
                    = f.date_field :bill_date, class: 'form-control'

                  .col-md-2
                    %label{:for => 'due_date'} Due Date:
                    = f.date_field :due_date , class: 'form-control'

                  .col-md-2
                    %label{:for => 'bill_no'} Bill no.
                    = f.text_field :bill_no, class: 'form-control'
                

                %br
                .row
                  .col-md-2
                    %label
                      %b
                        Account details:

                %br
                .row
                  .col-md-2.text-center
                    Expense type
                  .col-md-2.text-center
                    Description
                  .col-md-2.text-center
                    Status
                  .col-md-2.text-center
                    Amount
                  .col-md-2.text-center
                    Action

                = f.nested_fields_for :expense_accounts do |ff|
                  = ff.object.expense_type
                  .row.mt-2
                    .col-md-2
                      .plain-select
                        = ff.select  :expense_type, '', {}, class: "form-control select_expense_types"
                    .col-md-2
                      = ff.text_area :description, class: 'form-control', cols: "2", rows: "2"
                    .col-md-2
                      = ff.select :status, Expense.statuses.map { |key, value| [key.titleize, key] } , {class: "form-control" , required: true}
                    .col-md-2
                      = ff.number_field :amount, class: 'form-control expense_amount'
                    .col-md-2.text-center
                      = ff.remove_nested_fields_link 'Remove'
                %br
                = f.add_nested_fields_link :expense_accounts, 'Add row', class: 'btn btn-primary add_row'
                %br
                %br
                .row
                  .col-md-3
                    %label Attachments
                    %input{:name => "attachments", :type => "file"}/

                %br
                .row
                  .col-md-3.form-group
                    %label{:for => "memo"} Memo:
                    %textarea#comment.form-control{:rows => "5"}

                  .col-md-4 

                  .col-md-4.total-amount
                    Total    $0.00

                %br
                = f.submit 'Submit', class: 'btn btn-primary'

.remote_container_contract
= render "company/expenses/new_expense_type", for_remote: true

- content_for :scripts do
  :javascript 

    $(document).ready(function() {
      $('.add_row').click();
      var count = 0;
      set_expense_type_select('#expense_expense_accounts_attributes_0_expense_type', "Please select");
      var expense_terms = $( "#expense_terms option:selected" ).val().split("Net")[1];
      var due_date = "";
      $('#expense_terms').on('change', function() {
        expense_terms = $( "#expense_terms option:selected" ).val().split("Net")[1];
        var date = new Date($( "#expense_bill_date" ).val()),
        days = parseInt(expense_terms, 10);
        if(!isNaN(date.getTime())){
            dd = new Date(date.setDate(date.getDate() + days));
            due_date =  dd.getFullYear() + "-" + ("0" + (dd.getMonth() + 1)).slice(-2)+ "-" + ("0" + dd.getDate()).slice(-2)

            $("#expense_due_date").val(due_date);
        }
      });

      $('#expense_bill_date').on('change', function() {

        var date = new Date($( "#expense_bill_date" ).val()),
        days = parseInt(expense_terms, 10);
        if(!isNaN(date.getTime())){
            dd = new Date(date.setDate(date.getDate() + days));
            due_date =  dd.getFullYear() + "-" + ("0" + (dd.getMonth() + 1)).slice(-2)+ "-" + ("0" + dd.getDate()).slice(-2)

            $("#expense_due_date").val(due_date);
        }

      });

      $('.add_row').on('click', function(){
        count = count + 1;
        select_id = "#expense_expense_accounts_attributes_"+count+"_expense_type"
        setTimeout(
            function() {
              set_expense_type_select(select_id, "Please select");  
            },
            500);
      })

      $('.remove_nested_fields_link').on('click', function(){
        count = count -1;
      })
     
      $(document).on("change",".expense_amount", function() {
        var sum = 0;
        $('.expense_amount').each(function(){
            sum += parseFloat(this.value);
        });
        $('.total-amount').text('Total  $'+sum)
      });

    }); 
